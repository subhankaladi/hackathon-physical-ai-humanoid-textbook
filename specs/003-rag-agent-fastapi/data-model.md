# Data Model: RAG Agent with OpenAI Agents SDK

## Query Request Entity

### Definition
Represents a user's text query that initiates the agent processing.

### Fields
- **query_text** (string, required)
  - The user-provided text query
  - Input text that will be processed by the agent
  - Maximum recommended size: 2000 characters

- **agent_context** (string, optional)
  - Additional context to guide the agent's behavior
  - Can include instructions about response style or focus
  - Default: empty string

### Validation Rules
- query_text must be non-empty
- query_text length should be reasonable (not exceed API limits)

## Retrieved Content Entity

### Definition
Represents content retrieved from Qdrant that informs the agent's response.

### Fields
- **content** (string, required)
  - The text content of the retrieved chunk
  - Original text content from the stored document
  - Maximum length depends on original chunking

- **url** (string, required)
  - Source URL of the content
  - Full URL where the original content was extracted from
  - Used for attribution and reference

- **position** (integer, required)
  - Position of chunk in original document
  - Zero-based index indicating order in document
  - Enables reconstruction of document order

- **similarity_score** (float, required)
  - Cosine similarity score between query and chunk
  - Range: 0.0 to 1.0 (higher is more similar)
  - Indicates relevance of chunk to query

- **chunk_id** (string, required)
  - Unique identifier for the chunk in Qdrant
  - UUID or hash identifier from Qdrant point ID
  - Used for reference and tracking

### Validation Rules
- similarity_score must be between 0.0 and 1.0
- content must be non-empty
- url must be a valid URL format

## Agent Response Entity

### Definition
JSON-formatted response containing answer, sources, and matched chunks from the agent.

### Fields
- **answer** (string, required)
  - The generated answer based on retrieved content
  - Text response generated by the OpenAI agent
  - Should be grounded in the retrieved information

- **sources** (array[string], required)
  - List of source URLs used to generate the answer
  - Unique URLs from which content was retrieved
  - Used for source attribution and verification

- **matched_chunks** (array[object], required)
  - List of content chunks that informed the answer
  - Contains the actual text snippets used by the agent
  - Each chunk includes content, URL, and similarity score

- **confidence** (string, optional)
  - Confidence level in the response (high/medium/low)
  - Based on similarity scores and number of matching chunks
  - Helps users understand response reliability

- **retrieval_time_ms** (integer, optional)
  - Time taken for the retrieval process in milliseconds
  - Used for performance monitoring
  - May be included in extended responses

### Validation Rules
- answer must be non-empty when results are available
- sources array should not contain duplicates
- matched_chunks should have meaningful content

## Agent Tool Response Entity

### Definition
Response format from the retrieval tool used by the OpenAI agent.

### Fields
- **query** (string, required)
  - The original query that triggered the retrieval
  - Echo of the input query for reference

- **retrieved_chunks** (array[Retrieved Content], required)
  - Array of retrieved content chunks with metadata
  - Contains up to top_k results that meet threshold criteria

- **total_results** (integer, required)
  - Total number of results returned
  - May be less than requested top_k if few matches

### Validation Rules
- retrieved_chunks array must contain between 0 and top_k elements
- total_results must match actual count of retrieved_chunks

## Process Data Flow

### Input Data
- **Source**: User-provided query text
- **Format**: Plain text query
- **Validation**: Check for query length and format

### Processing Data
- **Agent Processing**: OpenAI assistant processes query
- **Tool Calls**: Assistant may call retrieval tool
- **Retrieval**: Fetch relevant content from Qdrant
- **Answer Generation**: Assistant generates response based on content

### Output Data
- **Agent Response**: Generated answer with sources and chunks
- **Metadata**: Confidence level and timing information
- **JSON Response**: Formatted response for client consumption

## State Transitions

### Agent Lifecycle
1. **Received**: Query text received from user
2. **Processed**: Agent analyzes query and decides on actions
3. **Retrieved**: Agent calls retrieval tool if needed
4. **Answered**: Agent generates final response
5. **Formatted**: Response formatted into JSON structure
6. **Returned**: Response delivered to user

## Constraints

### Size Constraints
- Query text length: < 2000 characters
- Individual chunk content: < 2000 characters (as per storage)
- Answer length: < 4000 characters (to stay within token limits)

### Performance Constraints
- Agent processing time: < 10 seconds for 95% of queries
- Total response time: < 15 seconds including retrieval
- Tool response time: < 5 seconds for retrieval operations

### Data Integrity
- Retrieved content must match stored original
- Sources must be properly attributed
- Answer must be grounded in retrieved content